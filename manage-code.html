<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Architect - Admin Portal</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Monaco Editor Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <style>
        :root { 
            --body-bg: #F3F4F6; --widget-bg: #FFFFFF; --border-color: #E5E7EB; 
            --text-primary: #111827; --text-secondary: #4B5563; --brand-purple: #6D28D9; 
            --hover-bg: #F9FAFB; --danger: #EF4444; --success: #10B981; 
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); }

        /* Header */
        .header { background: var(--widget-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .logo { height: 32px; display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--brand-purple); font-size: 1.2rem; }

        .container { max-width: 1100px; margin: 0 auto; padding: 2rem 1rem; }
        
        .view { display: none; }
        .view.active { display: block; }

        /* Buttons */
        .btn { padding: 0.6rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn-p { background: var(--brand-purple); color: white; }
        .btn-p:hover { background: #5B21B6; transform: translateY(-1px); }
        .btn-s { background: white; border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-danger { color: var(--danger); background: #FEF2F2; }

        /* Assignment Table */
        .card-table { background: white; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1.25rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: #F9FAFB; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.05em; }

        /* Problem Editor UI */
        .problem-card { background: white; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 1.5rem; box-shadow: var(--shadow); }
        .problem-header { padding: 1.25rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .problem-header h3 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .problem-body { display: none; padding: 1.5rem; border-top: 1px solid var(--border-color); background: #fdfdfd; }
        .problem-card.open .problem-body { display: block; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
        input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; outline: none; }
        
        /* Monaco Editor Container */
        .editor-container { height: 350px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-top: 0.5rem; }

        /* Test Cases */
        .tc-wrapper { background: #F3F4F6; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; }
        .tc-row { display: grid; grid-template-columns: 1fr 1fr 120px 45px; gap: 10px; background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); align-items: end; }
        .tc-type { padding: 0.75rem; border-radius: 8px; background: #eee; border: none; font-size: 0.8rem; font-weight: 600; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #ccc; border-radius: 20px; transition: .4s; }
        .slider:before { content: ""; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        #loading-overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand-purple); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Syncing with Cloud Database...</p>
    </div>

    <header class="header">
        <div class="logo"><i class='bx bx-code-alt'></i> IHTNAS CODE ADMIN</div>
        <div id="admin-email" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
    </header>

    <main class="container">
        <!-- VIEW 1: ASSIGNMENTS LIST -->
        <section id="list-view" class="view active">
            <a href="manage-courses.html" style="text-decoration: none; color: var(--brand-purple); font-weight: 600; display: block; margin-bottom: 1rem;">
                <i class='bx bx-left-arrow-alt'></i> Back to Courses
            </a>
            <div class="admin-content-header">
                <h2>Coding Assignments</h2>
                <button class="btn btn-p" onclick="openAssignmentModal()"><i class='bx bx-plus'></i> New Assignment</button>
            </div>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>Assignment Name</th>
                            <th>Duration</th>
                            <th>Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assignments-tbody"></tbody>
                </table>
            </div>
        </section>

        <!-- VIEW 2: PROBLEMS EDITOR -->
        <section id="editor-view" class="view">
            <div class="admin-content-header" style="align-items: flex-start; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-s" onclick="showListView()"><i class='bx bx-arrow-back'></i> Back to List</button>
                <h2 id="current-assignment-title" style="margin-top: 1rem;">Assignment Problems</h2>
            </div>
            <div id="problems-container" style="margin-top: 2rem;"></div>
            <button class="btn btn-p" id="add-problem-btn" style="width: 100%; justify-content: center; padding: 1.5rem; margin-top: 1rem; border: 2px dashed #ccc; background: transparent; color: var(--text-secondary);">
                <i class='bx bx-plus-circle'></i> Add New Problem to this Assignment
            </button>
        </section>
    </main>

    <!-- ASSIGNMENT MODAL -->
    <div class="modal-overlay" id="assignment-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; place-items:center;">
        <div class="modal-content" style="background:white; padding:2rem; border-radius:15px; width:450px;">
            <h3>Assignment Settings</h3><br>
            <input type="hidden" id="edit-assignment-id">
            <div class="form-field"><label>Title</label><input type="text" id="m-title"></div>
            <div class="form-grid">
                <div class="form-field"><label>Duration (Mins)</label><input type="number" id="m-dur"></div>
                <div class="form-field"><label>Deadline</label><input type="date" id="m-dead"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-p" style="flex:1" onclick="saveAssignment()">Save</button>
                <button class="btn btn-s" style="flex:1" onclick="closeAssignmentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb"; // Ensure this is your full long key
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";
        let currentCourseId = null;
        let activeAssignment = null;
        let editors = {}; // Stores Monaco instances

        const templates = {
            javascript: "function solution(input) {\n    // Standard JS Logic\n    return input;\n}",
            python: "def solution(input):\n    # Python 3 Logic\n    return input",
            java: "public class Main {\n    public static void main(String[] args) {\n        // Java 17 logic\n    }\n}",
            c: "#include <stdio.h>\n\nint main() {\n    return 0;\n}",
            html: "<!DOCTYPE html>\n<html>\n<body>\n    <h1>Test</h1>\n</body>\n</html>"
        };

        // Initialize Monaco
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session && session.user.email === ADMIN_EMAIL) {
                document.getElementById('admin-email').innerText = session.user.email;
                const urlParams = new URLSearchParams(window.location.search);
                currentCourseId = urlParams.get('courseId');
                
                if (!currentCourseId) window.location.href = 'manage-courses.html';
                
                loadAssignments();
                document.getElementById('loading-overlay').style.display = 'none';
            } else {
                window.location.href = 'index.html';
            }
        }
        init();

        // Assignment Management
        async function loadAssignments() {
            const tbody = document.getElementById('assignments-tbody');
            const { data } = await supabaseClient.from('code_assignments').select('*').eq('course_id', currentCourseId).order('created_at', {ascending: false});
            
            tbody.innerHTML = '';
            data?.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600">${a.name}</td>
                    <td>${a.duration/60} mins</td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" onchange="toggleLock('${a.id}', this.checked)" ${!a.is_locked ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <button class="btn btn-p" onclick="openProblemEditor('${a.id}', '${a.name}')"><i class='bx bx-cog'></i> Manage Problems</button>
                        <button class="btn btn-s" onclick="editAssignmentMeta('${a.id}')"><i class='bx bx-edit'></i></button>
                        <button class="btn btn-s btn-danger" onclick="deleteAssignment('${a.id}')"><i class='bx bx-trash'></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleLock(id, status) {
            await supabaseClient.from('code_assignments').update({ is_locked: !status }).eq('id', id);
        }

        function openAssignmentModal() { 
            document.getElementById('assignment-form').reset();
            document.getElementById('edit-assignment-id').value = '';
            document.getElementById('assignment-modal').style.display = 'grid'; 
        }
        function closeAssignmentModal() { document.getElementById('assignment-modal').style.display = 'none'; }

        async function editAssignmentMeta(id) {
            const { data } = await supabaseClient.from('code_assignments').select('*').eq('id', id).single();
            document.getElementById('edit-assignment-id').value = data.id;
            document.getElementById('m-title').value = data.name;
            document.getElementById('m-dur').value = data.duration / 60;
            document.getElementById('m-dead').value = data.deadline;
            document.getElementById('assignment-modal').style.display = 'grid';
        }

        async function saveAssignment() {
            const id = document.getElementById('edit-assignment-id').value;
            const payload = {
                name: document.getElementById('m-title').value,
                duration: document.getElementById('m-dur').value * 60,
                deadline: document.getElementById('m-dead').value || null,
                course_id: currentCourseId
            };
            
            if(id) await supabaseClient.from('code_assignments').update(payload).eq('id', id);
            else await supabaseClient.from('code_assignments').insert([{...payload, is_locked: true}]);
            
            closeAssignmentModal();
            loadAssignments();
        }

        async function deleteAssignment(id) {
            if(confirm("Delete assignment and all problems?")) {
                await supabaseClient.from('code_assignments').delete().eq('id', id);
                loadAssignments();
            }
        }

        // Problem Editor Management
        function showListView() {
            document.getElementById('editor-view').classList.remove('active');
            document.getElementById('list-view').classList.add('active');
        }

        async function openProblemEditor(id, title) {
            activeAssignment = id;
            document.getElementById('current-assignment-title').innerText = "Problems for: " + title;
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('editor-view').classList.add('active');
            loadProblems();
        }

        async function loadProblems() {
            const container = document.getElementById('problems-container');
            const { data: problems } = await supabaseClient.from('code_problems').select('*').eq('assignment_id', activeAssignment).order('created_at', {ascending: true});
            
            container.innerHTML = '';
            problems?.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'problem-card';
                card.id = `card-${p.id}`;
                card.innerHTML = `
                    <div class="problem-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3><i class='bx bx-chevron-right'></i> Problem ${idx+1}: ${p.title}</h3>
                        <div style="font-size: 0.8rem; background: #eee; padding: 4px 10px; border-radius: 20px;">${p.language.toUpperCase()}</div>
                    </div>
                    <div class="problem-body">
                        <form onsubmit="updateProblem(event, '${p.id}')">
                            <div class="form-grid">
                                <div class="form-field"><label>Title</label><input type="text" name="title" value="${p.title}" required></div>
                                <div class="form-field"><label>Points</label><input type="number" name="points" value="${p.points}" required></div>
                            </div>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label>Language</label>
                                    <select name="language" onchange="changeEditorLang('${p.id}', this.value)">
                                        <option value="javascript" ${p.language=='javascript'?'selected':''}>JavaScript</option>
                                        <option value="python" ${p.language=='python'?'selected':''}>Python 3</option>
                                        <option value="java" ${p.language=='java'?'selected':''}>Java</option>
                                        <option value="c" ${p.language=='c'?'selected':''}>C</option>
                                        <option value="html" ${p.language=='html'?'selected':''}>HTML</option>
                                    </select>
                                </div>
                                <div class="form-field"><label>Function Name (Entry Point)</label><input type="text" name="function_name" value="${p.function_name}" required></div>
                            </div>
                            <div class="form-field"><label>Problem Description (HTML allowed)</label><textarea name="statement" rows="3">${p.statement || ''}</textarea></div>
                            
                            <label>Starter Code (Advanced Editor)</label>
                            <div id="editor-${p.id}" class="editor-container"></div>

                            <div class="tc-wrapper">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
                                    <h4 style="font-weight:700">Test Bench</h4>
                                    <button type="button" class="btn btn-s" onclick="addTestCaseUI('${p.id}')">+ Add Case</button>
                                </div>
                                <div id="tc-list-${p.id}"></div>
                            </div>

                            <div style="margin-top:2rem; display:flex; justify-content:flex-end; gap:10px;">
                                <button type="submit" class="btn btn-p">Save Problem</button>
                                <button type="button" class="btn btn-danger" onclick="deleteProblem('${p.id}')">Delete Problem</button>
                            </div>
                        </form>
                    </div>
                `;
                container.appendChild(card);
                
                // Mount Monaco
                require(['vs/editor/editor.main'], function() {
                    editors[p.id] = monaco.editor.create(document.getElementById(`editor-${p.id}`), {
                        value: p.starter_code || templates[p.language],
                        language: p.language === 'python' ? 'python' : (p.language === 'java' ? 'java' : 'javascript'),
                        theme: 'vs-dark',
                        fontFamily: 'Fira Code',
                        fontSize: 14,
                        minimap: { enabled: false },
                        automaticLayout: true
                    });
                });

                // Load Test Cases
                if(p.test_cases) p.test_cases.forEach(tc => addTestCaseUI(p.id, tc));
            });
        }

        function addTestCaseUI(problemId, data = null) {
            const list = document.getElementById(`tc-list-${problemId}`);
            const div = document.createElement('div');
            div.className = 'tc-row';
            div.innerHTML = `
                <div><label>Input</label><input type="text" class="tc-in" placeholder='[1, 2]' value='${data?.input || ""}'></div>
                <div><label>Output</label><input type="text" class="tc-out" placeholder='3' value='${data?.output || ""}'></div>
                <div>
                    <label>Visibility</label>
                    <select class="tc-v">
                        <option value="public" ${data?.visibility=='public'?'selected':''}>Public</option>
                        <option value="hidden" ${data?.visibility=='hidden'?'selected':''}>Hidden</option>
                    </select>
                </div>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:0.75rem"><i class='bx bx-trash'></i></button>
            `;
            list.appendChild(div);
        }

        function changeEditorLang(pid, lang) {
            const model = editors[pid].getModel();
            monaco.editor.setModelLanguage(model, lang === 'python' ? 'python' : (lang === 'java' ? 'java' : 'javascript'));
            if(confirm("Apply " + lang + " template?")) {
                editors[pid].setValue(templates[lang]);
            }
        }

        async function updateProblem(e, id) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const card = document.getElementById(`card-${id}`);
            
            const testCases = [];
            card.querySelectorAll('.tc-row').forEach(row => {
                testCases.push({
                    input: row.querySelector('.tc-in').value,
                    output: row.querySelector('.tc-out').value,
                    visibility: row.querySelector('.tc-v').value
                });
            });

            const payload = {
                title: fd.get('title'),
                points: parseInt(fd.get('points')),
                statement: fd.get('statement'),
                function_name: fd.get('function_name'),
                language: fd.get('language'),
                starter_code: editors[id].getValue(),
                test_cases: testCases
            };

            const { error } = await supabaseClient.from('code_problems').update(payload).eq('id', id);
            if(!error) alert("Problem Synced to Database!");
            else alert("Error: " + error.message);
        }

        document.getElementById('add-problem-btn').onclick = async () => {
            const { error } = await supabaseClient.from('code_problems').insert([{
                assignment_id: activeAssignment,
                title: "New Challenge",
                points: 10,
                language: 'javascript',
                function_name: 'solution',
                starter_code: templates.javascript,
                test_cases: []
            }]);
            loadProblems();
        };

        async function deleteProblem(id) {
            if(confirm("Delete this problem?")) {
                await supabaseClient.from('code_problems').delete().eq('id', id);
                loadProblems();
            }
        }

    </script>
</body>
</html>
