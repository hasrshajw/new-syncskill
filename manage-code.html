<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Code Assignments - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root { 
            --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB; 
            --text-primary: #002726; --text-secondary: #6B7280; --brand-purple: #6D28D9; 
            --hover-bg: #F3F4F6; --danger-color: #EF4444; --success-color: #10B981; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; }
        
        .header { 
            background: var(--widget-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;
        }
        .logo-img { height: 32px; }

        .container { max-width: 1000px; margin: 0 auto; padding: 2rem 1rem; }
        
        .admin-view { display: none; } 
        .admin-view.active { display: block; }
        
        .admin-content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .admin-content-header h2 { font-size: 1.75rem; font-weight: 700; }

        .primary-btn, .secondary-btn { padding: 0.6rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .primary-btn { background-color: var(--brand-purple); color: white; }
        .secondary-btn { background-color: var(--hover-bg); color: var(--text-primary); }
        .back-btn { margin-bottom: 1rem; color: var(--brand-purple); font-weight: 600; text-decoration: none; cursor: pointer; display: inline-block; }

        .table-wrap { background: var(--widget-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: #f9fafb; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); }

        .problem-card { background: var(--widget-bg); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 1rem; overflow: hidden; }
        .problem-header { padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; background: #fff; }
        .problem-body { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .problem-header.active + .problem-body { max-height: 2000px; border-top: 1px solid var(--border-color); }
        .problem-body-content { padding: 1.5rem; }

        .form-field { margin-bottom: 1rem; }
        .form-field label { display: block; margin-bottom: 4px; font-weight: 600; }
        .form-field input, .form-field textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; place-items: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.show { display: grid; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 100%; max-width: 500px; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: var(--danger-color); border-radius: 20px; transition: .4s; }
        .slider:before { content: ""; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        #loading-overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="loading-overlay">Authenticating Admin...</div>

    <header class="header">
        <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" class="logo-img">
        <span style="font-weight: 700; color: var(--text-secondary);">Code Assignment Admin</span>
    </header>

    <main class="container">
        <!-- Assignments List View -->
        <div id="assignments-view" class="admin-view active">
            <a href="manage-subjects.html" class="back-btn"><i class='bx bx-arrow-back'></i> Back to Courses</a>
            <div class="admin-content-header">
                <h2 id="page-title">Code Assignments</h2>
                <button class="primary-btn" id="create-assignment-btn"><i class='bx bx-plus'></i> Create New</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Name</th><th>Duration</th><th>Deadline</th><th>Active</th><th>Actions</th></tr></thead>
                    <tbody id="assignments-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Problems Editor View -->
        <div id="problems-view" class="admin-view">
            <button class="back-btn" id="back-to-assignments-btn"><i class='bx bx-arrow-back'></i> Back to Assignments</button>
            <div class="admin-content-header">
                <h2 id="problems-page-title">Problems</h2>
                <div style="display:flex; gap:10px;">
                    <button class="primary-btn" id="add-problem-btn"><i class='bx bx-plus'></i> Add Problem</button>
                </div>
            </div>
            <div id="problems-container"></div>
        </div>
    </main>

    <!-- Assignment Modal -->
    <div class="modal-overlay" id="assignment-modal">
        <div class="modal-content">
            <h3 id="assignment-modal-title" style="margin-bottom:1.5rem;">Assignment</h3>
            <form id="assignment-form">
                <input type="hidden" id="assignment-id">
                <div class="form-field"><label>Assignment Name</label><input type="text" id="assignment-name" placeholder="e.g. Java Logic Challenge" required></div>
                <div class="form-grid">
                    <div class="form-field"><label>Duration (mins)</label><input type="number" id="assignment-duration" required></div>
                    <div class="form-field"><label>Deadline</label><input type="date" id="assignment-deadline"></div>
                </div>
                <div class="form-field" style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="assignment-locked" style="width:auto;"><label>Locked for students</label>
                </div>
                <div style="display:flex; gap:10px; margin-top:1.5rem;">
                    <button type="button" class="primary-btn" id="save-assignment-btn" style="flex:1; justify-content:center;">Save</button>
                    <button type="button" class="secondary-btn" onclick="this.closest('.modal-overlay').classList.remove('show')" style="flex:1; justify-content:center;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";

        let currentCourseId = null;
        let currentAssignment = null;

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session && session.user.email === ADMIN_EMAIL) {
                const urlParams = new URLSearchParams(window.location.search);
                currentCourseId = urlParams.get('courseId');
                if (!currentCourseId) return window.location.href = 'manage-subjects.html';
                
                document.getElementById('loading-overlay').style.display = 'none';
                loadAssignments();
            } else { window.location.href = 'index.html'; }
        }
        checkAuth();

        async function loadAssignments() {
            const tbody = document.getElementById('assignments-tbody');
            const { data: assignments } = await supabase
                .from('code_assignments')
                .select('*')
                .eq('course_id', currentCourseId)
                .order('created_at', { ascending: false });

            tbody.innerHTML = '';
            assignments?.forEach(data => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600">${data.name}</td>
                    <td>${data.duration / 60}m</td>
                    <td>${data.deadline ? new Date(data.deadline).toLocaleDateString() : 'None'}</td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" onchange="toggleLock('${data.id}', this.checked)" ${!data.is_locked ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <button class="primary-btn" style="padding:4px 8px" onclick="openProblems('${data.id}', '${data.name}')">Problems</button>
                        <button onclick="editAssignment('${data.id}')" style="background:none; border:none; cursor:pointer; color:var(--brand-purple); font-weight:700; margin-left:10px;">Edit</button>
                        <button onclick="deleteAssignment('${data.id}')" style="background:none; border:none; cursor:pointer; color:var(--danger-color); font-weight:700; margin-left:10px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleLock(id, isActive) { 
            await supabase.from('code_assignments').update({ is_locked: !isActive }).eq('id', id); 
        }

        async function openProblems(id, name) {
            currentAssignment = { id, name };
            document.getElementById('problems-page-title').textContent = `Problems: ${name}`;
            document.getElementById('assignments-view').classList.remove('active');
            document.getElementById('problems-view').classList.add('active');
            loadProblems();
        }

        document.getElementById('back-to-assignments-btn').onclick = () => {
            document.getElementById('problems-view').classList.remove('active');
            document.getElementById('assignments-view').classList.add('active');
        };

        async function loadProblems() {
            const container = document.getElementById('problems-container');
            const { data: problems } = await supabase
                .from('code_problems')
                .select('*')
                .eq('assignment_id', currentAssignment.id)
                .order('id', { ascending: true });

            container.innerHTML = '';
            problems?.forEach(p => {
                const card = document.createElement('div');
                card.className = 'problem-card';
                card.innerHTML = `
                    <div class="problem-header" onclick="this.classList.toggle('active')">
                        <span>${p.title} (${p.points} pts)</span>
                        <i class='bx bx-chevron-down'></i>
                    </div>
                    <div class="problem-body">
                        <div class="problem-body-content">
                            <form onsubmit="saveProblem(event, '${p.id}')">
                                <div class="form-grid">
                                    <div class="form-field"><label>Title</label><input type="text" name="title" value="${p.title}" required></div>
                                    <div class="form-field"><label>Points</label><input type="number" name="points" value="${p.points}" required></div>
                                </div>
                                <div class="form-field"><label>Statement (HTML)</label><textarea name="statement" rows="3">${p.statement || ''}</textarea></div>
                                <div class="form-field"><label>Function Name</label><input type="text" name="function_name" value="${p.function_name}" required></div>
                                <div class="form-field"><label>Starter Code</label><textarea name="starter_code" rows="4">${p.starter_code || ''}</textarea></div>
                                <div style="text-align:right">
                                    <button type="submit" class="primary-btn">Update Problem</button>
                                    <button type="button" class="secondary-btn" onclick="deleteProblem('${p.id}')" style="color:red">Delete</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function saveProblem(e, id) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const { error } = await supabase.from('code_problems').update({
                title: fd.get('title'),
                points: parseInt(fd.get('points')),
                statement: fd.get('statement'),
                function_name: fd.get('function_name'),
                starter_code: fd.get('starter_code')
            }).eq('id', id);
            
            if(!error) alert('Updated!');
            else alert(error.message);
        }

        async function deleteProblem(id) { 
            if(confirm('Delete problem?')) {
                await supabase.from('code_problems').delete().eq('id', id);
                loadProblems();
            }
        }

        document.getElementById('add-problem-btn').onclick = async () => {
            const { error } = await supabase.from('code_problems').insert([{
                title: 'New Problem', 
                points: 10, 
                statement: 'Enter problem description here...', 
                function_name: 'solution', 
                starter_code: 'function solution() {\n\n}', 
                assignment_id: currentAssignment.id
            }]);
            if(!error) loadProblems();
        };

        // Modal Logic
        const modal = document.getElementById('assignment-modal');
        document.getElementById('create-assignment-btn').onclick = () => {
            document.getElementById('assignment-form').reset();
            document.getElementById('assignment-id').value = '';
            modal.classList.add('show');
        };

        async function editAssignment(id) {
            const { data: d } = await supabase.from('code_assignments').select('*').eq('id', id).single();
            if(d) {
                document.getElementById('assignment-id').value = id;
                document.getElementById('assignment-name').value = d.name;
                document.getElementById('assignment-duration').value = d.duration / 60;
                if(d.deadline) document.getElementById('assignment-deadline').value = d.deadline;
                document.getElementById('assignment-locked').checked = d.is_locked;
                modal.classList.add('show');
            }
        }

        document.getElementById('save-assignment-btn').onclick = async () => {
            const id = document.getElementById('assignment-id').value;
            const name = document.getElementById('assignment-name').value;
            const duration = parseInt(document.getElementById('assignment-duration').value) * 60;
            const deadline = document.getElementById('assignment-deadline').value || null;
            const is_locked = document.getElementById('assignment-locked').checked;

            const data = { name, duration, is_locked, course_id: currentCourseId, deadline };
            
            let res;
            if(id) res = await supabase.from('code_assignments').update(data).eq('id', id);
            else res = await supabase.from('code_assignments').insert([data]);
            
            if(!res.error) {
                modal.classList.remove('show');
                loadAssignments();
            } else {
                alert(res.error.message);
            }
        };

        async function deleteAssignment(id) { 
            if(confirm('Delete assignment and all problems inside?')) {
                await supabase.from('code_assignments').delete().eq('id', id);
                loadAssignments();
            }
        }
    </script>
</body>
</html>
