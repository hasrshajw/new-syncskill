<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB;
            --text-primary: #111827; --text-secondary: #6B7280; --brand-purple: #6D28D9;
            --brand-purple-hover: #5B21B6; --hover-bg: #F3F4F6; --danger-color: #EF4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; line-height: 1.5; }
        
        .main-header { 
            padding: 1rem 2.5rem; 
            background-color: var(--widget-bg); 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo-image { height: 32px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
        .admin-content-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 2rem; 
        }
        .admin-content-header h1 { font-size: 1.75rem; font-weight: 700; }

        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .course-card { 
            background: var(--widget-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .course-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .card-content { padding: 1.5rem; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .card-header h3 { font-size: 1.15rem; font-weight: 600; }
        .card-filename { color: var(--text-secondary); font-family: monospace; font-size: 0.85rem; }
        
        .card-actions { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            border-top: 1px solid var(--border-color); 
            background: #fdfdfd;
            border-radius: 0 0 12px 12px;
        }
        .action-link { 
            padding: 0.75rem 0.25rem; 
            text-align: center; 
            font-weight: 600; 
            font-size: 0.75rem; 
            color: var(--text-primary);
            text-decoration: none;
            border-right: 1px solid var(--border-color);
        }
        .action-link:last-child { border-right: none; }
        .action-link:hover { background: var(--hover-bg); }

        .primary-btn { 
            background: var(--brand-purple); color: white; border: none; 
            padding: 0.7rem 1.2rem; border-radius: 8px; font-weight: 600; 
            cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
        }
        .primary-btn:hover { background: var(--brand-purple-hover); }
        
        .action-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary); }
        .action-dropdown { 
            position: absolute; right: 20px; background: white; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg); border-radius: 8px; display: none; z-index: 10;
        }
        .action-dropdown.active { display: block; }
        .dropdown-item { 
            padding: 0.6rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 8px; width: 100%;
            border: none; background: none; font-size: 0.85rem; text-align: left;
        }
        .dropdown-item:hover { background: var(--hover-bg); }
        .dropdown-item.delete { color: var(--danger-color); }

        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; place-items: center; z-index: 1000; backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: grid; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 450px; }
        .form-field { margin-bottom: 1rem; }
        .form-field label { display: block; margin-bottom: 0.4rem; font-weight: 600; }
        .form-field input { width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; }

        @media (max-width: 600px) {
            .admin-content-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .primary-btn { width: 100%; justify-content: center; }
            .main-header { padding: 1rem; }
        }
        
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    </style>
</head>
<body>
    <div id="loading-overlay">Authenticating Admin...</div>

    <header class="main-header">
        <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" class="logo-image">
        <div style="font-weight: 600; color: var(--text-secondary);">Course Management</div>
    </header>

    <main class="container">
        <div class="admin-content-header">
            <h1>All Courses</h1>
            <button class="primary-btn" id="create-course-btn"><i class='bx bx-plus'></i> Create New Course</button>
        </div>
        <div class="courses-grid" id="courses-grid"></div>
    </main>

    <!-- Course Modal -->
    <div class="modal-overlay" id="course-modal">
        <div class="modal-content">
            <h3 id="course-modal-title" style="margin-bottom: 1.5rem;">Course</h3>
            <form id="course-form">
                <input type="hidden" id="course-id">
                <div class="form-field">
                    <label>Course Name</label>
                    <input type="text" id="course-name" placeholder="e.g. Java Programming" required>
                </div>
                <div class="form-field">
                    <label>Page Filename</label>
                    <input type="text" id="course-page" placeholder="java-course.html" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 2rem;">
                    <button type="button" class="primary-btn" id="save-course-btn" style="flex: 1; justify-content: center;">Save Course</button>
                    <button type="button" onclick="closeModal()" style="flex: 1; background: #eee; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Include Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = "YOUR_SUPABASE_PROJECT_URL";
        const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";

        // Check Auth State
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session && session.user.email === ADMIN_EMAIL) {
                document.getElementById('loading-overlay').style.display = 'none';
                loadCourses();
            } else {
                window.location.href = 'index.html'; // Redirect if not admin
            }
        }
        checkAuth();

        // Load Courses from Supabase
        async function loadCourses() {
            const grid = document.getElementById('courses-grid');
            const { data: courses, error } = await supabase
                .from('courses')
                .select('*')
                .order('name', { ascending: true });

            if (error) return console.error(error);

            grid.innerHTML = '';
            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.innerHTML = `
                    <div class="card-content">
                        <div class="card-header">
                            <h3>${course.name}</h3>
                            <div style="position:relative">
                                <button class="action-btn" onclick="toggleDropdown(event, this)"><i class='bx bx-dots-vertical-rounded'></i></button>
                                <div class="action-dropdown">
                                    <button class="dropdown-item" onclick="editCourse('${course.id}')"><i class='bx bx-edit'></i> Edit</button>
                                    <button class="dropdown-item delete" onclick="deleteCourse('${course.id}')"><i class='bx bx-trash'></i> Delete</button>
                                </div>
                            </div>
                        </div>
                        <p class="card-filename">${course.page_filename || 'No file set'}</p>
                    </div>
                    <div class="card-actions">
                        <a href="manage-lessons.html?courseId=${course.id}" class="action-link">Lessons</a>
                        <a href="manage-exams.html?courseId=${course.id}" class="action-link">MCQ Exams</a>
                        <a href="manage-code.html?courseId=${course.id}" class="action-link">Code Exams</a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Toggle Card Dropdown
        function toggleDropdown(e, btn) {
            e.stopPropagation();
            document.querySelectorAll('.action-dropdown').forEach(d => d.classList.remove('active'));
            btn.nextElementSibling.classList.toggle('active');
        }

        window.onclick = () => document.querySelectorAll('.action-dropdown').forEach(d => d.classList.remove('active'));

        // Modal Controls
        const modal = document.getElementById('course-modal');
        document.getElementById('create-course-btn').onclick = () => {
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
            document.getElementById('course-modal-title').innerText = 'Create New Course';
            modal.classList.add('show');
        };

        function closeModal() { modal.classList.remove('show'); }

        // Edit Course
        async function editCourse(id) {
            const { data: course } = await supabase.from('courses').select('*').eq('id', id).single();
            if (course) {
                document.getElementById('course-id').value = course.id;
                document.getElementById('course-name').value = course.name;
                document.getElementById('course-page').value = course.page_filename;
                document.getElementById('course-modal-title').innerText = 'Edit Course';
                modal.classList.add('show');
            }
        }

        // Delete Course
        async function deleteCourse(id) {
            if(confirm('Delete this course? All lessons, exams, and content inside will be lost forever.')) {
                const { error } = await supabase.from('courses').delete().eq('id', id);
                if (!error) loadCourses();
            }
        }

        // Save/Update Course
        document.getElementById('save-course-btn').onclick = async () => {
            const id = document.getElementById('course-id').value;
            const name = document.getElementById('course-name').value;
            const page_filename = document.getElementById('course-page').value;
            
            if(!name || !page_filename) return alert('Fill all fields');

            const courseData = { name, page_filename };

            let response;
            if(id) {
                // Update
                response = await supabase.from('courses').update(courseData).eq('id', id);
            } else {
                // Create
                response = await supabase.from('courses').insert([courseData]);
            }

            if (response.error) {
                alert("Error saving course: " + response.error.message);
            } else {
                closeModal();
                loadCourses();
            }
        };
    </script>
</body>
</html>
