<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses - Admin Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB;
            --text-primary: #111827; --text-secondary: #6B7280; --brand-purple: #6D28D9;
            --brand-purple-hover: #5B21B6; --hover-bg: #F3F4F6; --danger-color: #EF4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; line-height: 1.5; }
        
        .main-header { 
            padding: 1rem 2.5rem; 
            background-color: var(--widget-bg); 
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .logo-group { display: flex; align-items: center; gap: 12px; }
        .logo-image { height: 32px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
        .admin-content-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
        }
        .admin-content-header h1 { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.02em; }

        /* Course Grid */
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .course-card { 
            background: var(--widget-bg); border: 1px solid var(--border-color); 
            border-radius: 14px; transition: all 0.2s ease; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .course-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--brand-purple); }
        
        .card-content { padding: 1.5rem; flex: 1; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .card-header h3 { font-size: 1.15rem; font-weight: 700; line-height: 1.3; }
        
        .lang-badge { 
            display: inline-block; background: var(--hover-bg); color: var(--brand-purple);
            padding: 3px 10px; border-radius: 6px; font-weight: 700; font-size: 0.7rem; text-transform: uppercase;
        }

        .card-actions { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; 
            border-top: 1px solid var(--border-color); background: #fafafa;
        }
        .action-link { 
            padding: 0.85rem 0.25rem; text-align: center; font-weight: 700; font-size: 0.75rem; 
            color: var(--text-primary); text-decoration: none; border-right: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        .action-link:last-child { border-right: none; }
        .action-link:hover { background: #fff; color: var(--brand-purple); }

        /* Buttons */
        .primary-btn { 
            background: var(--brand-purple); color: white; border: none; 
            padding: 0.7rem 1.4rem; border-radius: 10px; font-weight: 700; 
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .primary-btn:hover { background: var(--brand-purple-hover); transform: translateY(-1px); }
        
        .logout-btn { color: var(--danger-color); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        .action-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary); border-radius: 50%; }
        .action-btn:hover { background: var(--hover-bg); }
        
        .action-dropdown { 
            position: absolute; right: 20px; background: white; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg); border-radius: 10px; display: none; z-index: 10; overflow: hidden;
        }
        .action-dropdown.active { display: block; }
        .dropdown-item { 
            padding: 0.75rem 1.2rem; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%;
            border: none; background: none; font-size: 0.85rem; text-align: left; font-weight: 500;
        }
        .dropdown-item:hover { background: var(--hover-bg); }
        .dropdown-item.delete { color: var(--danger-color); }

        /* Modal */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; place-items: center; z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-overlay.show { display: grid; }
        .modal-content { background: white; padding: 2.5rem; border-radius: 20px; width: 95%; max-width: 450px; box-shadow: var(--shadow-lg); }
        .form-field { margin-bottom: 1.25rem; }
        .form-field label { display: block; margin-bottom: 6px; font-weight: 700; color: var(--text-secondary); font-size: 0.85rem; }
        .form-field input, .form-field select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; outline: none; }
        .form-field input:focus { border-color: var(--brand-purple); box-shadow: 0 0 0 3px rgba(109,40,217,0.1); }

        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="loading-overlay">Verifying Admin Access...</div>

    <header class="main-header">
        <div class="logo-group">
            <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" class="logo-image">
            <div style="height: 20px; width: 1px; background: var(--border-color);"></div>
            <span style="font-weight: 700; color: var(--text-secondary);">Course Manager</span>
        </div>
        <a href="logout.html" class="logout-btn"><i class='bx bx-log-out'></i> Logout</a>
    </header>

    <main class="container">
        <div class="admin-content-header">
            <h1>Active Courses</h1>
            <button class="primary-btn" onclick="openCreateModal()"><i class='bx bx-plus-circle'></i> Create New Course</button>
        </div>
        <div class="courses-grid" id="courses-grid"></div>
    </main>

    <!-- Course Modal -->
    <div class="modal-overlay" id="course-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 1.5rem; letter-spacing: -0.02em;">New Course</h2>
            <form id="course-form">
                <input type="hidden" id="course-id">
                <div class="form-field">
                    <label>Course Name</label>
                    <input type="text" id="course-name" placeholder="e.g. Full Stack Web Development" required>
                </div>
                <div class="form-field">
                    <label>Primary Programming Language (Optional)</label>
                    <select id="course-lang">
                        <option value="">General / No Specific Language</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="c">C Language</option>
                        <option value="cpp">C++</option>
                        <option value="html">HTML/CSS</option>
                        <option value="javascript">JavaScript</option>
                        <option value="sql">SQL</option>
                    </select>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 2.5rem;">
                    <button type="button" class="primary-btn" id="save-btn" style="flex: 2; justify-content: center;">Save Course</button>
                    <button type="button" onclick="closeModal()" style="flex: 1; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-weight: 700;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session && session.user.email === ADMIN_EMAIL) {
                document.getElementById('loading-overlay').style.display = 'none';
                loadCourses();
            } else {
                window.location.href = 'index.html'; 
            }
        }
        checkAuth();

        async function loadCourses() {
            const grid = document.getElementById('courses-grid');
            const { data: courses, error } = await supabaseClient
                .from('courses')
                .select('*')
                .order('name', { ascending: true });

            if (error) return console.error(error);

            grid.innerHTML = '';
            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                // Language guard: avoid toLowerCase() on null
                const langDisplay = course.language || 'General';
                
                card.innerHTML = `
                    <div class="card-content">
                        <div class="card-header">
                            <h3>${course.name}</h3>
                            <div style="position:relative">
                                <button class="action-btn" onclick="toggleDropdown(event, this)"><i class='bx bx-dots-vertical-rounded' style='font-size:1.4rem'></i></button>
                                <div class="action-dropdown">
                                    <button class="dropdown-item" onclick="editCourse('${course.id}')"><i class='bx bx-edit-alt'></i> Edit Name/Lang</button>
                                    <button class="dropdown-item delete" onclick="deleteCourse('${course.id}')"><i class='bx bx-trash'></i> Delete Course</button>
                                </div>
                            </div>
                        </div>
                        <span class="lang-badge">${langDisplay}</span>
                    </div>
                    <div class="card-actions">
                        <a href="manage-lessons.html?courseId=${course.id}" class="action-link">CURRICULUM</a>
                        <a href="manage-exams.html?courseId=${course.id}" class="action-link">EXAMS</a>
                        <a href="manage-code.html?courseId=${course.id}" class="action-link">CODE LABS</a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleDropdown(e, btn) {
            e.stopPropagation();
            document.querySelectorAll('.action-dropdown').forEach(d => d.classList.remove('active'));
            btn.nextElementSibling.classList.toggle('active');
        }

        window.onclick = () => document.querySelectorAll('.action-dropdown').forEach(d => d.classList.remove('active'));

        const modal = document.getElementById('course-modal');
        
        // FIX: Explicitly reset form AND hidden ID
        function openCreateModal() {
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
            document.getElementById('modal-title').innerText = 'Create New Course';
            modal.classList.add('show');
        }

        function closeModal() { modal.classList.remove('show'); }

        async function editCourse(id) {
            const { data: course } = await supabaseClient.from('courses').select('*').eq('id', id).single();
            if (course) {
                document.getElementById('course-id').value = course.id;
                document.getElementById('course-name').value = course.name;
                document.getElementById('course-lang').value = course.language || "";
                document.getElementById('modal-title').innerText = 'Edit Course Settings';
                modal.classList.add('show');
            }
        }

        async function deleteCourse(id) {
            if(confirm('CRITICAL: This will permanently delete this course and ALL associated lessons, exams, and student progress. Continue?')) {
                const { error } = await supabaseClient.from('courses').delete().eq('id', id);
                
                if (error) {
                    if (error.code === '23503') {
                        alert("Delete Failed: This course has linked data. Please check if ON DELETE CASCADE is enabled in Supabase.");
                    } else {
                        alert("Error: " + error.message);
                    }
                } else {
                    loadCourses();
                }
            }
        }

        document.getElementById('save-btn').onclick = async () => {
            const id = document.getElementById('course-id').value;
            const name = document.getElementById('course-name').value.trim();
            const language = document.getElementById('course-lang').value;
            
            if(!name) return alert('Course Name is required');

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerText = "Processing...";

            const courseData = { name, language: language || null };

            let res;
            if(id) {
                res = await supabaseClient.from('courses').update(courseData).eq('id', id);
            } else {
                res = await supabaseClient.from('courses').insert([courseData]);
            }

            if (res.error) {
                alert("Error saving: " + res.error.message);
                saveBtn.disabled = false;
                saveBtn.innerText = "Save Course";
            } else {
                closeModal();
                loadCourses();
                saveBtn.disabled = false;
                saveBtn.innerText = "Save Course";
            }
        };
    </script>
</body>
</html>
