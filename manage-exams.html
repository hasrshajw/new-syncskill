<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Exams - Admin Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB;
            --text-primary: #111827; --text-secondary: #6B7280; --brand-purple: #6D28D9;
            --brand-purple-hover: #5B21B6; --success: #10B981; --danger: #EF4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; line-height: 1.5; }
        
        .main-header { padding: 1rem 2.5rem; background: var(--widget-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo-img { height: 30px; }

        .container { max-width: 1000px; margin: 0 auto; padding: 2rem 1.25rem; }
        .back-link { display: inline-flex; align-items: center; gap: 5px; color: var(--brand-purple); font-weight: 700; text-decoration: none; margin-bottom: 1rem; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        
        /* Table Optimization */
        .table-wrapper { background: var(--widget-bg); border-radius: 14px; border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--shadow-sm); }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #F9FAFB; padding: 1rem; font-size: 11px; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.05em; }
        td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--border-color); }

        /* Status Toggle */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #D1D5DB; border-radius: 20px; transition: .3s; }
        .slider:before { content: ""; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .3s; }
        input:checked + .slider { background: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Buttons */
        .btn { padding: 0.7rem 1.2rem; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--brand-purple); color: white; }
        .btn-primary:hover { background: var(--brand-purple-hover); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #f3f4f6; color: var(--text-primary); }
        
        /* Modal - Large for Questions */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; place-items: center; z-index: 1000; padding: 1rem; }
        .modal.show { display: grid; }
        .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 750px; padding: 2.5rem; max-height: 90vh; overflow-y: auto; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .field label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary); }
        .field input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; outline: none; }
        .field input:focus { border-color: var(--brand-purple); }

        .question-box { background: #F9FAFB; padding: 1.5rem; border-radius: 14px; border: 1px solid var(--border-color); margin-top: 1rem; position: relative; }
        .remove-q-btn { position: absolute; top: 1rem; right: 1rem; color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.2rem; }

        #loading-overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    </style>
</head>
<body>

    <div id="loading-overlay">Checking Credentials...</div>

    <header class="main-header">
        <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" class="logo-img">
        <div style="font-weight: 700; color: var(--text-secondary);">Examination Control</div>
    </header>

    <main class="container">
        <a href="manage-courses.html" class="back-link"><i class='bx bx-arrow-back'></i> Back to Courses</a>
        
        <div class="header-flex">
            <h1 id="page-title" style="font-size: 1.8rem; letter-spacing: -0.02em;">Loading...</h1>
            <button class="btn btn-primary" onclick="openCreateModal()"><i class='bx bx-plus-circle'></i> New Exam</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Exam Title</th>
                        <th>Time Limit</th>
                        <th>Deadline</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="exams-list"></tbody>
            </table>
        </div>
    </main>

    <!-- Optimized Modal -->
    <div class="modal" id="exam-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 2rem;">Exam Configuration</h2>
            <form id="exam-form" onsubmit="return false;">
                <input type="hidden" id="exam-id">
                
                <div class="form-row">
                    <div class="field"><label>Exam Name</label><input type="text" id="exam-name" placeholder="Midterm Exam" required></div>
                    <div class="field"><label>Duration (Minutes)</label><input type="number" id="exam-duration" min="1" placeholder="60" required></div>
                </div>
                
                <div class="form-row">
                    <div class="field"><label>Deadline Date</label><input type="date" id="exam-deadline"></div>
                    <div class="field" style="display: flex; align-items: flex-end; padding-bottom: 5px;">
                        <button type="button" class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="addQuestionUI()">+ Add Question</button>
                    </div>
                </div>
                
                <div id="q-list-container" style="margin-top: 1.5rem;"></div>

                <div style="display:flex; gap:12px; margin-top:3rem; padding-top: 2rem; border-top: 1px solid #eee;">
                    <button type="button" class="btn btn-primary" id="save-exam-btn" style="flex:2; justify-content:center">Save Assessment</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex:1; justify-content:center">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";
        const courseId = new URLSearchParams(window.location.search).get('courseId');

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session && session.user.email === ADMIN_EMAIL && courseId) {
                const { data: course } = await supabaseClient.from('courses').select('name').eq('id', courseId).single();
                document.getElementById('page-title').textContent = (course?.name || "Course") + " Exams";
                document.getElementById('loading-overlay').style.display = 'none';
                loadExams();
            } else {
                window.location.href = 'index.html';
            }
        }
        checkAuth();

        // FIX: Performance - only select necessary fields for the list
        async function loadExams() {
            const list = document.getElementById('exams-list');
            const { data: exams, error } = await supabaseClient
                .from('exams')
                .select('id, name, duration, deadline, is_locked')
                .eq('course_id', courseId)
                .order('created_at', { ascending: false });

            if (error) return console.error(error);

            list.innerHTML = exams.length ? '' : '<tr><td colspan="5" style="text-align:center; color:#999">No exams created yet.</td></tr>';
            
            exams.forEach(e => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:700">${e.name}</td>
                    <td>${Math.floor(e.duration / 60)} min</td>
                    <td>${e.deadline ? new Date(e.deadline).toLocaleDateString() : 'No Limit'}</td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" onchange="toggleLock('${e.id}', this.checked)" ${!e.is_locked ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <button onclick="editExam('${e.id}')" class="btn btn-secondary" style="padding:6px 10px"><i class='bx bx-edit-alt'></i> Edit</button>
                        <button onclick="deleteExam('${e.id}')" class="btn btn-secondary" style="padding:6px 10px; color:var(--danger); margin-left:8px"><i class='bx bx-trash'></i></button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        async function toggleLock(id, isActive) {
            await supabaseClient.from('exams').update({ is_locked: !isActive }).eq('id', id);
        }

        async function deleteExam(id) {
            if(confirm('Permanently delete this exam? This cannot be undone.')) {
                await supabaseClient.from('exams').delete().eq('id', id);
                loadExams();
            }
        }

        const modal = document.getElementById('exam-modal');
        function closeModal() { modal.classList.remove('show'); }

        // FIX: Form State Reset - explicitly clear hidden ID
        function openCreateModal() {
            document.getElementById('exam-form').reset();
            document.getElementById('exam-id').value = '';
            document.getElementById('q-list-container').innerHTML = '';
            document.getElementById('modal-title').innerText = 'Create New Exam';
            modal.classList.add('show');
            addQuestionUI();
        }

        // FIX: Lazy Load - fetch payload ONLY when editing
        async function editExam(id) {
            const { data: e } = await supabaseClient.from('exams').select('*').eq('id', id).single();
            if(!e) return;
            
            document.getElementById('exam-id').value = e.id;
            document.getElementById('exam-name').value = e.name;
            document.getElementById('exam-duration').value = Math.floor(e.duration / 60);
            if (e.deadline) document.getElementById('exam-deadline').value = e.deadline.split('T')[0];
            
            document.getElementById('q-list-container').innerHTML = '';
            if(e.payload) e.payload.forEach(q => addQuestionUI(q));
            
            document.getElementById('modal-title').innerText = 'Modify Assessment';
            modal.classList.add('show');
        }

        function addQuestionUI(q = null) {
            const div = document.createElement('div');
            div.className = 'question-box';
            div.innerHTML = `
                <button type="button" class="remove-q-btn" onclick="this.parentElement.remove()"><i class='bx bx-x-circle'></i></button>
                <div class="field" style="margin-bottom:15px">
                    <label>Question Title</label>
                    <input type="text" class="qt" placeholder="e.g. What is a primary key?" value="${q?.title || ''}" required>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <input type="text" class="o0" placeholder="Option A" value="${q?.options?.[0] || ''}" required>
                    <input type="text" class="o1" placeholder="Option B" value="${q?.options?.[1] || ''}" required>
                    <input type="text" class="o2" placeholder="Option C" value="${q?.options?.[2] || ''}" required>
                    <input type="text" class="o3" placeholder="Option D" value="${q?.options?.[3] || ''}" required>
                </div>
                <div style="margin-top:15px; display:flex; align-items:center; gap:20px; background:#fff; padding:10px; border-radius:8px;">
                    <label style="font-size:12px; margin:0">Correct Index (0-3): 
                        <input type="number" class="qc" min="0" max="3" value="${q?.correctAnswer ?? 0}" style="width:45px; padding:4px;" required>
                    </label>
                    <label style="font-size:12px; margin:0">Score/Points: 
                        <input type="number" class="qp" min="1" value="${q?.points ?? 1}" style="width:55px; padding:4px;" required>
                    </label>
                </div>
            `;
            document.getElementById('q-list-container').appendChild(div);
        }

        // FIX: Strict Validation & UX (Loading State)
        document.getElementById('save-exam-btn').onclick = async () => {
            const form = document.getElementById('exam-form');
            if(!form.checkValidity()) return form.reportValidity();

            const saveBtn = document.getElementById('save-exam-btn');
            const id = document.getElementById('exam-id').value;
            
            // FIX: Sanitization
            const durationMins = Math.max(1, parseInt(document.getElementById('exam-duration').value) || 60);
            const deadline = document.getElementById('exam-deadline').value || null;
            
            const questions = [];
            document.querySelectorAll('.question-box').forEach(box => {
                questions.push({
                    title: box.querySelector('.qt').value.trim(),
                    options: [
                        box.querySelector('.o0').value.trim(), 
                        box.querySelector('.o1').value.trim(), 
                        box.querySelector('.o2').value.trim(), 
                        box.querySelector('.o3').value.trim()
                    ],
                    correctAnswer: Math.min(3, Math.max(0, parseInt(box.querySelector('.qc').value) || 0)),
                    points: Math.max(1, parseInt(box.querySelector('.qp').value) || 1)
                });
            });

            if(questions.length === 0) return alert("Please add at least one question.");

            saveBtn.disabled = true;
            saveBtn.innerText = "Syncing...";

            const examData = { 
                name: document.getElementById('exam-name').value.trim(), 
                duration: durationMins * 60, 
                course_id: courseId, 
                payload: questions, 
                deadline 
            };
            
            let res;
            if(id) res = await supabaseClient.from('exams').update(examData).eq('id', id);
            else res = await supabaseClient.from('exams').insert([{ ...examData, is_locked: true }]);
            
            if(!res.error) {
                closeModal();
                loadExams();
            } else {
                alert("Database Error: " + res.error.message);
            }
            saveBtn.disabled = false;
            saveBtn.innerText = "Save Exam";
        };
    </script>
</body>
</html>
