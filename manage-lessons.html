<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Content - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB;
            --text-primary: #111827; --text-secondary: #6B7280; --brand-purple: #6D28D9;
            --brand-purple-hover: #5B21B6; --hover-bg: #F3F4F6; --danger-color: #EF4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; line-height: 1.5; }
        
        .main-header { 
            padding: 1rem 2rem; background: var(--widget-bg); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;
        }
        .logo-image { height: 30px; }

        .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
        .back-btn { display: inline-flex; align-items: center; gap: 5px; color: var(--brand-purple); font-weight: 600; text-decoration: none; margin-bottom: 1rem; }
        .admin-content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }

        .chapter-block { background: var(--widget-bg); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: var(--shadow-sm); }
        .chapter-header { padding: 1rem 1.5rem; background: #FDFDFD; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .chapter-title { font-size: 1.1rem; font-weight: 700; }
        
        .lessons-list { padding: 0.5rem; }
        .lesson-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; border-radius: 8px; transition: background 0.2s; }
        .lesson-item:hover { background: var(--hover-bg); }
        .lesson-icon { font-size: 1.25rem; color: var(--text-secondary); }
        .lesson-details { flex: 1; }
        .lesson-details .title { font-weight: 500; }
        
        .btn-group { display: flex; gap: 5px; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-secondary); font-size: 1.2rem; }
        .icon-btn:hover { color: var(--brand-purple); }
        .icon-btn.delete:hover { color: var(--danger-color); }

        .add-content-area { padding: 1rem; display: flex; gap: 10px; border-top: 1px solid var(--border-color); background: #fafafa; }
        .primary-btn { background: var(--brand-purple); color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .secondary-btn { background: white; border: 1px solid var(--border-color); padding: 0.6rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        
        .add-chapter-btn { width: 100%; padding: 1.5rem; border: 2px dashed var(--border-color); border-radius: 12px; background: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; margin-top: 1rem; }
        .add-chapter-btn:hover { border-color: var(--brand-purple); color: var(--brand-purple); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; place-items: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.show { display: grid; }
        .modal-content { background: white; border-radius: 12px; width: 100%; max-width: 600px; padding: 1.5rem; max-height: 90vh; overflow-y: auto; }
        .form-field { margin-bottom: 1rem; }
        .form-field label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-field input, .form-field textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; }
        
        .question-card { border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-top: 1rem; background: #f9f9f9; position: relative; }
        .remove-q-btn { position: absolute; top: 10px; right: 10px; color: var(--danger-color); cursor: pointer; border: none; background: none; }

        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    </style>
</head>
<body>
    <div id="loading-overlay">Authenticating Admin...</div>

    <header class="main-header">
        <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" class="logo-image">
        <div style="font-weight: 600; color: var(--text-secondary);">Content Manager</div>
    </header>

    <main class="container">
        <a href="manage-subjects.html" class="back-btn"><i class='bx bx-arrow-back'></i> Back to Courses</a>
        
        <div class="admin-content-header">
            <h1 id="page-title">Loading Course...</h1>
        </div>

        <div id="lesson-editor-container"></div>
        
        <button class="add-chapter-btn" id="add-chapter-btn"><i class='bx bx-plus'></i> Add New Chapter</button>
    </main>

    <!-- Generic Modal -->
    <div class="modal-overlay" id="generic-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-bottom:1.5rem">Title</h3>
            <div id="modal-body-content"></div>
            <div style="display:flex; gap:10px; margin-top:2rem">
                <button class="primary-btn" id="modal-save-btn" style="flex:1; justify-content:center">Save</button>
                <button class="secondary-btn" onclick="closeAllModals()" style="flex:1">Cancel</button>
            </div>
        </div>
    </div>

<!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        // Fixed missing quote below
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
        
        // Changed variable name to supabaseClient to avoid SyntaxError
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";
        let currentCourse = null;

        async function checkAuth() {
            // Updated to use supabaseClient
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session && session.user.email === ADMIN_EMAIL) {
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                if (!courseId) return window.location.href = 'manage-subjects.html';
                
                await loadCourseData(courseId);
                document.getElementById('loading-overlay').style.display = 'none';
            } else {
                window.location.href = 'index.html';
            }
        }
        checkAuth();

        async function loadCourseData(id) {
            const { data, error } = await supabaseClient.from('courses').select('*').eq('id', id).single();
            if (data) {
                currentCourse = data;
                document.getElementById('page-title').textContent = data.name;
                renderContent();
            }
        }

        async function renderContent() {
            const container = document.getElementById('lesson-editor-container');
            container.innerHTML = '';
            
            const chapters = currentCourse.chapters || [];
            
            for (let idx = 0; idx < chapters.length; idx++) {
                const block = document.createElement('div');
                block.className = 'chapter-block';
                block.innerHTML = `
                    <div class="chapter-header">
                        <span class="chapter-title">${idx + 1}. ${chapters[idx]}</span>
                        <div class="btn-group">
                            <button class="icon-btn" onclick="openChapterModal(${idx})"><i class='bx bx-edit'></i></button>
                            <button class="icon-btn delete" onclick="deleteChapter(${idx})"><i class='bx bx-trash'></i></button>
                        </div>
                    </div>
                    <div class="lessons-list" id="list-${idx}">Loading items...</div>
                    <div class="add-content-area">
                        <button class="secondary-btn" onclick="openLessonModal(${idx})">+ Lesson</button>
                        <button class="primary-btn" onclick="openQuizModal(${idx})">+ Quiz</button>
                    </div>
                `;
                container.appendChild(block);
                loadItems(idx);
            }
        }

        async function loadItems(chIdx) {
            const list = document.getElementById(`list-${chIdx}`);
            const { data: items } = await supabaseClient
                .from('lessons')
                .select('*')
                .eq('course_id', currentCourse.id)
                .eq('chapter_index', chIdx)
                .order('order_index', { ascending: true });

            list.innerHTML = (!items || items.length === 0) ? '<p style="padding:1rem; color:#999; text-align:center">Empty Chapter</p>' : '';
            
            items?.forEach(item => {
                const div = document.createElement('div');
                div.className = 'lesson-item';
                div.innerHTML = `
                    <i class='bx ${item.type === 'quiz' ? 'bx-help-circle' : 'bx-file'} lesson-icon'></i>
                    <div class="lesson-details"><div class="title">${item.title}</div></div>
                    <div class="btn-group">
                        <button class="icon-btn" onclick="editItem('${item.id}', '${item.type}', ${chIdx})"><i class='bx bx-edit-alt'></i></button>
                        <button class="icon-btn delete" onclick="deleteItem('${item.id}')"><i class='bx bx-trash'></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Modal Controls
        const modal = document.getElementById('generic-modal');
        function closeAllModals() { modal.classList.remove('show'); }

        function openChapterModal(idx = null) {
            document.getElementById('modal-title').innerText = idx !== null ? 'Rename Chapter' : 'Add Chapter';
            document.getElementById('modal-body-content').innerHTML = `
                <div class="form-field"><label>Chapter Name</label><input type="text" id="chapter-name" value="${idx !== null ? currentCourse.chapters[idx] : ''}"></div>
            `;
            modal.classList.add('show');
            document.getElementById('modal-save-btn').onclick = async () => {
                const name = document.getElementById('chapter-name').value;
                let chapters = [...(currentCourse.chapters || [])];
                if (idx !== null) chapters[idx] = name; else chapters.push(name);
                
                await supabaseClient.from('courses').update({ chapters }).eq('id', currentCourse.id);
                loadCourseData(currentCourse.id);
                closeAllModals();
            };
        }

        async function openLessonModal(chIdx, lessonId = null) {
            let existing = null;
            if(lessonId) {
                const { data } = await supabaseClient.from('lessons').select('*').eq('id', lessonId).single();
                existing = data;
            }

            document.getElementById('modal-title').innerText = lessonId ? 'Edit Lesson' : 'Add Lesson';
            document.getElementById('modal-body-content').innerHTML = `
                <div class="form-field"><label>Lesson Title</label><input type="text" id="l-title" value="${existing?.title || ''}"></div>
                <div class="form-field"><label>Duration</label><input type="text" id="l-dur" value="${existing?.duration || ''}"></div>
                <div class="form-field"><label>Content (HTML)</label><textarea id="l-content" rows="8">${existing?.content || ''}</textarea></div>
            `;
            modal.classList.add('show');
            document.getElementById('modal-save-btn').onclick = async () => {
                const payload = {
                    title: document.getElementById('l-title').value,
                    duration: document.getElementById('l-dur').value,
                    content: document.getElementById('l-content').value,
                    type: 'lesson', course_id: currentCourse.id, chapter_index: chIdx
                };
                if (lessonId) await supabaseClient.from('lessons').update(payload).eq('id', lessonId);
                else await supabaseClient.from('lessons').insert([payload]);
                
                renderContent();
                closeAllModals();
            };
        }

        async function openQuizModal(chIdx, quizId = null) {
            let existing = null;
            if(quizId) {
                const { data } = await supabaseClient.from('lessons').select('*').eq('id', quizId).single();
                existing = data;
            }

            document.getElementById('modal-title').innerText = quizId ? 'Edit Quiz' : 'Add Quiz';
            document.getElementById('modal-body-content').innerHTML = `
                <div class="form-field"><label>Quiz Title</label><input type="text" id="q-title" value="${existing?.title || ''}"></div>
                <div id="q-container"></div>
                <button class="secondary-btn" onclick="addQuestionUI()" style="margin-top:10px">+ Add Question</button>
            `;
            
            if (existing?.payload) existing.payload.forEach(q => addQuestionUI(q));
            else addQuestionUI();

            modal.classList.add('show');
            document.getElementById('modal-save-btn').onclick = async () => {
                const questions = [];
                document.querySelectorAll('.question-card').forEach(card => {
                    questions.push({
                        title: card.querySelector('.qt').value,
                        options: [card.querySelector('.o0').value, card.querySelector('.o1').value, card.querySelector('.o2').value, card.querySelector('.o3').value],
                        correctAnswer: parseInt(card.querySelector('.qc').value),
                        points: 5
                    });
                });
                const data = { 
                    title: document.getElementById('q-title').value, 
                    payload: questions, 
                    type: 'quiz', course_id: currentCourse.id, chapter_index: chIdx 
                };
                if (quizId) await supabaseClient.from('lessons').update(data).eq('id', quizId);
                else await supabaseClient.from('lessons').insert([data]);
                
                renderContent();
                closeAllModals();
            };
        }

        function addQuestionUI(q = null) {
            const div = document.createElement('div');
            div.className = 'question-card';
            div.innerHTML = `
                <button class="remove-q-btn" onclick="this.parentElement.remove()"><i class='bx bx-x'></i></button>
                <input type="text" class="qt" placeholder="Question Text" value="${q?.title || ''}" style="margin-bottom:8px; font-weight:600">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px">
                    <input type="text" class="o0" placeholder="Option A" value="${q?.options?.[0] || ''}">
                    <input type="text" class="o1" placeholder="Option B" value="${q?.options?.[1] || ''}">
                    <input type="text" class="o2" placeholder="Option C" value="${q?.options?.[2] || ''}">
                    <input type="text" class="o3" placeholder="Option D" value="${q?.options?.[3] || ''}">
                </div>
                <div style="margin-top:8px; font-size:12px; color:var(--text-secondary)">Correct Index (0-3)</div>
                <input type="number" class="qc" min="0" max="3" value="${q?.correctAnswer || 0}">
            `;
            document.getElementById('q-container').appendChild(div);
        }

        async function editItem(id, type, chIdx) {
            if (type === 'quiz') await openQuizModal(chIdx, id);
            else await openLessonModal(chIdx, id);
        }

        async function deleteItem(id) { 
            if(confirm('Delete this item?')) {
                await supabaseClient.from('lessons').delete().eq('id', id);
                renderContent();
            }
        }

        async function deleteChapter(idx) {
            if(confirm('Are you sure? Items inside this chapter will still exist in the database but won\'t be visible.')) {
                let chapters = currentCourse.chapters.filter((_, i) => i !== idx);
                await supabaseClient.from('courses').update({ chapters }).eq('id', currentCourse.id);
                loadCourseData(currentCourse.id);
            }
        }

        document.getElementById('add-chapter-btn').onclick = () => openChapterModal();
    </script>
</body>
</html>
